name: CD

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

jobs:
  build-and-test:
    name: Build and test (reuse CI checks)
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint (flake8)
        run: flake8 .

      - name: Unit tests with coverage (pytest)
        run: |
          pytest tests \
                 --maxfail=1 --disable-warnings \
                 --cov=main --cov=tests \
                 --cov-report=term-missing --cov-fail-under=80

      - name: BDD tests (behave)
        run: behave

      - name: Security scan (Bandit)
        run: bandit -r main.py

      - name: Dependency security scan (pip-audit)
        run: pip-audit


  qa-tests:
    name: QA tests on runner (E2E + performance + security)
    needs: build-and-test
    runs-on: ubuntu-latest
    environment:
      name: qa

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start application locally for QA tests
        run: |
          nohup uvicorn main:app --host 0.0.0.0 --port 8000 > uvicorn.log 2>&1 &
          sleep 5

      - name: Run E2E HTTP tests against local QA app
        env:
          BP_APP_BASE_URL: http://127.0.0.1:8000
        run: pytest tests_e2e

      - name: Run performance tests against local QA app
        env:
          BP_APP_BASE_URL: http://127.0.0.1:8000
        run: pytest -s tests_performance

      - name: Run security HTTP tests against local QA app
        env:
          BP_APP_BASE_URL: http://127.0.0.1:8000
        run: pytest tests_security


  deploy-to-prod:
    name: Deploy to Azure Production
    needs: qa-tests
    runs-on: ubuntu-latest
    environment:
      name: production   # approval gate

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Install dependencies into .python_packages for Azure
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt --target ".python_packages/lib/site-packages"

      - name: Create deployment package (include .python_packages)
        run: |
          zip -r app.zip . \
            -x ".git/*" ".github/*" ".venv/*" "**/__pycache__/*"

      - name: Deploy to Prod Web App via az webapp deploy
        run: |
          az webapp deploy \
            --resource-group rg-bp-app \
            --name bp-calculator-prod \
            --src-path app.zip \
            --type zip \
            --restart true

      - name: Smoke test home page on prod
        run: |
          curl -f https://bp-calculator-prod-gsfrdnbva8g6htf3.westeurope-01.azurewebsites.net/ || exit 1
