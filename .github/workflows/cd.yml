name: CD

on:
  # Manual trigger for demo / controlled releases
  workflow_dispatch:

  # Optional: tag-based releases like v1.0.0
  push:
    tags:
      - "v*.*.*"

jobs:
  build-and-test:
    name: Build and test (reuse CI checks)
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint (flake8)
        run: flake8 .

      - name: Unit tests with coverage (pytest)
        run: |
          pytest tests --maxfail=1 --disable-warnings \
                 --cov=main --cov-report=term-missing --cov-fail-under=80

      - name: BDD tests (behave)
        run: behave

      - name: Security scan (Bandit)
        run: bandit -r main.py

      - name: Dependency security scan (pip-audit)
        run: pip-audit

  deploy-to-qa:
    name: Deploy to QA environment
    needs: build-and-test
    runs-on: ubuntu-latest
    environment:
      name: qa

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # For now we start the app locally on the runner and run tests against it.
      # Later this will be replaced with a real Azure QA deployment.
      - name: Start QA server and run E2E/perf/security tests
        env:
          BASE_URL: http://127.0.0.1:8000
        run: |
          set -e

          echo "Starting FastAPI app on $BASE_URL ..."
          uvicorn main:app --host 0.0.0.0 --port 8000 &
          SERVER_PID=$!

          # Give the server time to start
          sleep 3

          # Ensure the server is killed when this step finishes (success or failure)
          trap "kill $SERVER_PID" EXIT

          echo "Running E2E HTTP tests against $BASE_URL ..."
          pytest tests_e2e

          echo "Running performance tests ..."
          pytest -s tests_performance

          echo "Running security checks ..."
          pytest tests_security

  deploy-to-prod:
    name: Deploy to Production environment
    needs: deploy-to-qa
    runs-on: ubuntu-latest
    environment:
      name: production

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      # TODO: Later will deploy the app to Azure Web App (prod)
      - name: Placeholder - Deploy to production
        run: |
          echo "Production deployment gate has been approved."
          echo "This is where the real Azure Web App deployment would run."
          echo "For the assignment, this acts as the final gated production step."
