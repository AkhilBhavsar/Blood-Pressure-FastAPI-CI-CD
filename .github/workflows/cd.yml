name: CD

on:
  workflow_dispatch:
  push:
    tags:
      - "v*.*.*"

jobs:
  build-and-test:
    name: Build and test (reuse CI checks)
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Lint (flake8)
        run: flake8 .

      - name: Unit tests with coverage (pytest)
        run: |
          pytest tests \
                 --maxfail=1 --disable-warnings \
                 --cov=main --cov=tests \
                 --cov-report=term-missing --cov-fail-under=80

      - name: BDD tests (behave)
        run: behave

      - name: Security scan (Bandit)
        run: bandit -r main.py

      - name: Dependency security scan (pip-audit)
        run: pip-audit

  deploy-to-qa:
    name: Deploy to Azure QA and run E2E/perf/security
    needs: build-and-test
    runs-on: ubuntu-latest
    environment:
      name: qa

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies (for tests)
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create deployment package
        run: |
          zip -r app.zip . -x ".git/*" ".github/*" ".venv/*" "__pycache__/*"

      - name: Deploy to QA Web App via az webapp deploy
        run: |
          az webapp deploy \
            --resource-group rg-bp-app \
            --name bp-calculator-qa \
            --src-path app.zip \
            --type zip \
            --restart true

      - name: Wait for QA deployment to warm up
        run: sleep 20

      - name: Run E2E HTTP tests against Azure QA
        env:
          BP_APP_BASE_URL: "https://bp-calculator-qa-cfd4eca5dwbffbc0.westeurope-01.azurewebsites.net"
        run: pytest tests_e2e

      - name: Run performance tests against Azure QA
        env:
          BP_APP_BASE_URL: "https://bp-calculator-qa-cfd4eca5dwbffbc0.westeurope-01.azurewebsites.net"
        run: pytest -s tests_performance

      - name: Run security tests against Azure QA
        env:
          BP_APP_BASE_URL: "https://bp-calculator-qa-cfd4eca5dwbffbc0.westeurope-01.azurewebsites.net"
        run: pytest tests_security

  deploy-to-prod:
    name: Deploy to Azure Production
    needs: deploy-to-qa
    runs-on: ubuntu-latest
    environment:
      name: production   # you already set this with an approval gate in GitHub

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create deployment package
        run: |
          zip -r app.zip . -x ".git/*" ".github/*" ".venv/*" "__pycache__/*"

      - name: Deploy to Prod Web App via az webapp deploy
        run: |
          az webapp deploy \
            --resource-group rg-bp-app \
            --name bp-calculator-prod \
            --src-path app.zip \
            --type zip \
            --restart true

      - name: Smoke test home page on prod
        run: |
          curl -f https://bp-calculator-prod-gsfrdnbva8g6htf3.westeurope-01.azurewebsites.net/ || exit 1
